@using WebArsip.Mvc.Helpers
@using WebArsip.Mvc.Models.ViewModels
@model IEnumerable<DocumentViewModel>

@{
    ViewData["Title"] = "Documents";
    Layout = "_LayoutPrivate";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>📄 Documents</h2>

    @if (UserRoleHelper.HasAccess(Context, "Document.Create"))
    {
        <a asp-controller="Document" asp-action="Create" class="btn btn-primary">➕ Add Document</a>
    }
</div>

<table id="documentTable" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>No</th>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>Created</th>
            <th>Updated</th>
            <th>File</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var doc in Model)
        {
            <tr>
                <td></td>
                <td>@doc.DocId</td>
                <td>@doc.Title</td>
                <td>@doc.Description</td>
                <td>@doc.Status</td>
                <td>@doc.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                <td>@(doc.UpdatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>

                <td>
                    @if (UserRoleHelper.HasAccess(Context, "Document.Download") && !string.IsNullOrEmpty(doc.FilePath))
                    {
                        <a href="@doc.FilePath" target="_blank" class="btn-download btn btn-sm btn-success" data-id="@doc.DocId" data-name="@doc.Title">📂 Download</a>
                    }
                    <button class="btn btn-sm btn-info btn-preview" data-file="@doc.FilePath" data-name="@doc.Title">
                        👁 Preview File
                    </button>
                </td>

                <td>
                    <a asp-action="Details" asp-route-id="@doc.DocId" class="btn btn-sm btn-info">✏ Details</a>

                    @if (UserRoleHelper.HasAccess(Context, "Document.Edit"))
                    {
                        <a asp-action="Edit" asp-route-id="@doc.DocId" class="btn btn-sm btn-warning">✏ Edit</a>
                    }

                    @if (UserRoleHelper.HasAccess(Context, "Document.Delete"))
                    {
                        <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="@doc.DocId" data-title="@doc.Title">🗑 Delete</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal Preview -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="previewModalLabel">📄 File Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContainer" class="text-center">
                    <p class="text-muted">Loading preview...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
                $(document).ready(function () {
            var table = $('#documentTable').DataTable({ pageLength: 10 });

            // numbering
            table.on('order.dt search.dt', function () {
                table.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();

            // delete confirm
            $(document).on('click', '.delete-btn', function () {
                var btn = $(this);
                var id = btn.data('id');
                var title = btn.data('title');

                Swal.fire({
                    title: "Yakin ingin hapus?",
                    text: "Dokumen \"" + title + "\" akan dihapus permanen.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Ya, hapus!",
                    cancelButtonText: "Batal"
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/Document/Delete/' + id,
                            type: 'POST',
                            success: function (res) {
                                if (res.success) {
                                    Swal.fire({ icon: 'success', title: res.message, timer: 1500, showConfirmButton: false });
                                    table.row(btn.closest('tr')).remove().draw(false);
                                } else {
                                    Swal.fire('Error', res.message, 'error');
                                }
                            },
                            error: function () {
                                Swal.fire('Error', 'Gagal menghapus dokumen.', 'error');
                            }
                        });
                    }
                });
            });

            //Download Button
            $(document).on('click', '.btn-download', function (e) {
            e.preventDefault();
            const id = $(this).data('id');
            const name = $(this).data('name');

            Swal.fire({
                title: 'Download File?',
                text: `Apakah kamu ingin mendownload dokumen "${name}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, download',
                cancelButtonText: 'Batal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Downloading...',
                        html: '<div class="spinner-border text-primary" role="status"></div>',
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });

                    // Lakukan download via window.open
                    window.location.href = `/Document/Download/${id}`;

                    setTimeout(() => {
                        Swal.close();
                        Swal.fire({
                            icon: 'success',
                            title: 'Download dimulai!',
                            text: 'File kamu sedang didownload.',
                            timer: 1800,
                            showConfirmButton: false
                        });
                    }, 1500);
                }
            });
        });

            // 🔹 Preview Modal Handler
        $(document).on('click', '.btn-preview', function () {
            const filePath = $(this).data('file');
            const name = $(this).data('name');
            const fullUrl = `http://localhost:5077${filePath}`;
            const encodedUrl = encodeURIComponent(fullUrl);

            let iframeUrl = '';

            if (filePath.endsWith('.pdf')) {
                iframeUrl = fullUrl; // langsung load pdf
            } else if (filePath.endsWith('.doc') || filePath.endsWith('.docx') || filePath.endsWith('.xls') || filePath.endsWith('.xlsx')) {
                iframeUrl = `https://view.officeapps.live.com/op/view.aspx?src=${encodedUrl}`;
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'Format tidak didukung',
                    text: 'File ini tidak bisa dipreview langsung.',
                    timer: 2000,
                    showConfirmButton: false
                });
                return;
            }

            $("#previewModalLabel").text(name);
            $("#previewFrame").attr("src", iframeUrl);
            $("#previewModal").modal("show");
        });

        // 🔹 SweetAlert Download Handler
        $(document).on('click', '.btn-download', function (e) {
            e.preventDefault();
            const id = $(this).data('id');
            const name = $(this).data('name');

            Swal.fire({
                title: 'Download File?',
                text: `Apakah kamu ingin mendownload dokumen "${name}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, download',
                cancelButtonText: 'Batal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Downloading...',
                        html: '<div class="spinner-border text-primary" role="status"></div>',
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });

                    window.location.href = `/Document/Download/${id}`;

                    setTimeout(() => {
                        Swal.close();
                        Swal.fire({
                            icon: 'success',
                            title: 'Download dimulai!',
                            text: 'File kamu sedang didownload.',
                            timer: 1800,
                            showConfirmButton: false
                        });
                    }, 1500);
                }
            });
        });

            // SweetAlert dari TempData
        @if (TempData["Success"] != null)
        {
            <text>
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '@TempData["Success"]', showConfirmButton: false, timer: 2000 });
            </text>
        }
        @if (TempData["Error"] != null)
        {
            <text>
                    Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: '@TempData["Error"]', showConfirmButton: false, timer: 2000 });
            </text>
        }
        });
    </script>
}
