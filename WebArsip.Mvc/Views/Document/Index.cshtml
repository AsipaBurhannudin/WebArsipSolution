@using WebArsip.Mvc.Helpers
@using WebArsip.Mvc.Models.ViewModels
@model IEnumerable<DocumentViewModel>

@{
    ViewData["Title"] = "Documents";
    Layout = "_LayoutPrivate";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>📄 Documents</h2>

    @if (UserRoleHelper.HasAccess(Context, "Document.Create"))
    {
        <a asp-controller="Document" asp-action="Create" class="btn btn-primary">➕ Add Document</a>
    }
</div>

<table id="documentTable" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>No</th>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>Created</th>
            <th>Updated</th>
            <th>File</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var doc in Model)
        {
            <tr>
                <td></td>
                <td>@doc.DocId</td>
                <td>@doc.Title</td>
                <td>@doc.Description</td>
                <td>@doc.Status</td>
                <td>@doc.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                <td>@(doc.UpdatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>

                <td>
                    @if (UserRoleHelper.HasAccess(Context, "Document.Download") && !string.IsNullOrEmpty(doc.FilePath))
                    {
                        <a href="@doc.FilePath" target="_blank" class="btn btn-sm btn-success">📂 Download</a>
                    }
                </td>

                <td>
                    <a asp-action="Details" asp-route-id="@doc.DocId" class="btn btn-sm btn-info">🔍 Details</a>

                    @if (UserRoleHelper.HasAccess(Context, "Document.Edit"))
                    {
                        <a asp-action="Edit" asp-route-id="@doc.DocId" class="btn btn-sm btn-warning">✏ Edit</a>
                    }

                    @if (UserRoleHelper.HasAccess(Context, "Document.Delete"))
                    {
                        <button type="button" class="btn btn-sm btn-danger delete-btn"
                                data-id="@doc.DocId" data-title="@doc.Title">
                            🗑 Delete
                        </button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 🔹 Init DataTables
            $('#documentTable').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[1, 'desc']],
                columnDefs: [{ targets: 0, orderable: false, searchable: false }]
            }).on('order.dt search.dt', function () {
                let table = $('#documentTable').DataTable();
                table.column(0, { search: 'applied', order: 'applied' })
                    .nodes()
                    .each((cell, i) => cell.innerHTML = i + 1);
            }).draw();

            // ✅ Notifikasi sukses/error dari TempData
        @if (TempData["Success"] != null)
        {
            <text>
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: '@TempData["Success"]',
                            showConfirmButton: false,
                            timer: 2000
                        });
            </text>
        }

        @if (TempData["Error"] != null)
        {
            <text>
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'error',
                            title: '@TempData["Error"]',
                            showConfirmButton: false,
                            timer: 2000
                        });
            </text>
        }

            // 🔹 SweetAlert2 Delete Confirmation
            $(".delete-btn").click(function () {
                var docId = $(this).data("id");
                var title = $(this).data("title");

                Swal.fire({
                    title: "Yakin hapus?",
                    text: "Dokumen \"" + title + "\" akan dihapus permanen!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Ya, hapus!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/Document/Delete/' + docId,
                            type: 'POST',
                            success: function (res) {
                                if (res.success) {
                                    Swal.fire({
                                        icon: "success",
                                        title: "Berhasil!",
                                        text: res.message,
                                        timer: 1500,
                                        showConfirmButton: false
                                    });
                                    setTimeout(() => location.reload(), 1600);
                                } else {
                                    Swal.fire("Error", res.message, "error");
                                }
                            },
                            error: function () {
                                Swal.fire("Error", "Gagal menghapus dokumen.", "error");
                            }
                        });
                    }
                });
            });
        });
    </script>
}
